# 树莓派多角度摄影系统使用说明

## 系统概述

这是一个基于树莓派的多角度摄影系统，支持最多20个摄像头通过NTP时间同步进行精确的同步拍摄，具备自动发现、动态连接和统一控制功能。

### 系统组成
- **主控制器**: 树莓派4 (协调所有摄像头节点，存储图片)
- **摄像头节点**: 最多20个树莓派5 + Camera Module 3
- **客户端**: iPad (通过WiFi连接进行控制)

## 核心特性

### 自动发现和连接
- 摄像头节点自动发现主控制器
- 动态分配节点ID，无需手动配置
- 实时显示连接状态和节点信息

### NTP时间同步拍摄
- 使用NTP服务器进行精确时间同步
- 支持0.5秒延迟的定时拍摄
- 所有摄像头在同一时刻触发拍摄

### 智能就绪检测
- 实时检测每个摄像头节点的就绪状态
- 只有就绪的摄像头参与拍摄
- iPad界面实时显示就绪状态

### 动态节点管理
- 支持节点热插拔，无需重启系统
- 实时更新iPad界面的摄像头列表
- 自动处理节点离线和重连

### 自动文件管理
- 照片自动传输到主控制器指定目录
- 文件名格式：`拍摄时间-节点序号.jpg`
- 同一次拍摄的照片存储在同一目录

## 硬件连接

### 网络连接 (无需GPIO线路)
- 所有设备连接到同一WiFi网络
- 主控制器: 192.168.1.100 (固定IP)
- 摄像头节点: 自动分配IP地址

### 设备配置
- **主控制器 (树莓派4)**: WiFi连接，运行Web服务
- **摄像头节点 (树莓派5)**: WiFi连接，Camera Module 3，自动注册
- **iPad**: WiFi连接，浏览器访问控制界面

## 软件安装

### 1. 主控制器安装 (树莓派4)

```bash
# 克隆项目
git clone <项目地址>
cd raspberry_pi_camera_array

# 运行安装脚本
sudo chmod +x setup/install_master.sh
sudo ./setup/install_master.sh

# 启动服务
sudo systemctl start camera-master
sudo systemctl enable camera-master
```

### 2. 摄像头节点安装 (树莓派5)

**新的简化安装流程 - 无需指定节点ID**

在每个树莓派5上运行：

```bash
# 克隆项目
git clone <项目地址>
cd raspberry_pi_camera_array

# 运行安装脚本（无需参数）
sudo chmod +x setup/install_node.sh
sudo ./setup/install_node.sh

# 重启系统
sudo reboot

# 重启后服务会自动启动
```

### 3. 开发环境安装

```bash
# 安装Python依赖
pip install -r requirements.txt

# 启动主控制器
python start_master.py

# 启动摄像头节点（支持自动分配ID）
python start_node.py
```

## 网络配置

### 自动IP分配
- 主控制器: 192.168.1.100 (固定)
- 摄像头节点: 自动获取DHCP地址
- 无需手动配置静态IP

### iPad连接
1. 确保iPad连接到同一WiFi网络
2. 在Safari中访问: `http://192.168.1.100:8080`
3. 将网页添加到主屏幕以获得类似App的体验

## 使用方法

### 1. 启动系统
1. 启动主控制器（树莓派4）
2. 启动摄像头节点（树莓派5们）- 它们会自动连接
3. 在iPad上打开浏览器访问主控制器地址
4. 观察摄像头节点逐个出现在界面上

### 2. 观察节点连接
- 新节点连接时会自动出现在摄像头列表中
- 界面显示节点ID、IP地址、连接状态
- 实时更新在线数量和就绪数量

### 3. 检查就绪状态
- 摄像头卡片显示"✓ 就绪"或"⚠ 未就绪"
- 只有就绪的摄像头会参与拍摄
- 拍摄按钮显示就绪摄像头数量

### 4. 预览摄像头
1. 点击任意在线摄像头卡片
2. 主预览区域显示该摄像头画面
3. 可以随时切换不同摄像头预览

### 5. 定时同步拍摄
1. 点击"拍摄"按钮
2. 系统自动检查所有摄像头就绪状态
3. 安排0.5秒后的同步拍摄时间
4. 所有就绪摄像头在精确时间同步拍摄
5. 照片自动传输到主控制器

### 6. 查看拍摄结果
- 拍摄历史显示每次拍摄的详细信息
- 包含会话ID、参与摄像头、拍摄时间
- 照片存储在主控制器的 `/opt/camera_images` 目录

## 扩展到20个节点

### 添加新节点
1. 准备新的树莓派5 + Camera Module 3
2. 运行标准安装脚本：`sudo ./setup/install_node.sh`
3. 重启新节点，它会自动连接到主控制器
4. 在iPad界面上观察新节点出现

### 节点管理
- **自动ID分配**: 系统自动为新节点分配唯一ID
- **热插拔支持**: 可以随时添加或移除节点
- **状态监控**: 实时监控所有节点的连接和就绪状态
- **故障恢复**: 节点重启后自动重连

### 性能考虑
- 主控制器可以轻松管理20个节点
- 网络带宽需求：每个节点约1-2MB/秒（拍摄时）
- 建议使用千兆网络交换机
- 确保WiFi信号覆盖所有节点位置

## 文件命名规则

### 照片文件名格式
```
拍摄时间-节点序号.jpg
例如: 20231211_143025_123-node01.jpg
```

### 目录结构
```
/opt/camera_images/
├── 20231211_143025_123-node01.jpg  # 节点1拍摄
├── 20231211_143025_123-node02.jpg  # 节点2拍摄
├── 20231211_143025_123-node15.jpg  # 节点15拍摄
└── 20231211_143025_123-node20.jpg  # 节点20拍摄
```

## 故障排除

### 常见问题

1. **节点无法自动连接**
   - 检查WiFi网络连接
   - 确认主控制器已启动
   - 查看节点日志: `journalctl -u camera-node -f`

2. **节点显示未就绪**
   - 检查摄像头模块连接
   - 确认摄像头权限: `sudo usermod -a -G video pi`
   - 重启节点服务: `sudo systemctl restart camera-node`

3. **时间同步失败**
   - 检查网络连接
   - 确认NTP服务: `sudo systemctl status ntp`
   - 手动同步: `sudo ntpdate -s time.nist.gov`

4. **iPad界面不更新**
   - 刷新浏览器页面
   - 检查WebSocket连接
   - 查看主控制器日志

### 监控命令

```bash
# 查看主控制器状态
sudo systemctl status camera-master
journalctl -u camera-master -f

# 查看节点状态
sudo systemctl status camera-node
journalctl -u camera-node -f

# 查看网络连接
ping 192.168.1.100
nmap -sn 192.168.1.0/24

# 测试节点API
curl http://节点IP:8084/ready
curl http://节点IP:8084/status
```

## 高级配置

### 自定义主控制器IP
如果需要更改主控制器IP，修改以下文件：
- `master_controller/config.py`
- `camera_node/config.py`

### 调整拍摄延迟
在 `shared/protocol.py` 中修改 `NTPConfig.CAPTURE_DELAY`

### 网络发现配置
在 `camera_node/config.py` 中调整：
- `discovery_broadcast_port`: 发现端口
- `discovery_timeout`: 发现超时时间

## 系统优势

1. **零配置部署**: 节点自动发现和连接，无需手动配置
2. **高度可扩展**: 轻松扩展到20个节点
3. **精确同步**: NTP时间同步确保毫秒级拍摄精度
4. **智能管理**: 自动检测设备状态，动态更新界面
5. **集中存储**: 所有照片自动传输到主控制器
6. **实时监控**: iPad界面实时显示所有节点状态
7. **故障恢复**: 节点断线重连后自动恢复

这个系统特别适合需要大量摄像头进行同步拍摄的应用场景，如3D扫描、运动分析、全景摄影等。